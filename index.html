<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A3</title>
    <!-- Tailwind CSS CDN para un estilo básico y moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Estilo general del cuerpo para un aspecto limpio */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #333;
        }

        /* Estilo básico para modales */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            max-width: 90%;
            width: 400px;
            position: relative;
        }
        .close-modal-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            color: #ccc;
            cursor: pointer;
        }

        /* Contenedor del chat simplificado */
        #chatContainer {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 90%;
            max-width: 350px;
            height: 450px;
            background-color: #fff;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            z-index: 999;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen">
    <!-- Pantalla de carga inicial -->
    <div id="loadingScreen" class="flex items-center justify-center min-h-screen w-full">
        <div class="text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-4 border-t-4 border-blue-500 mx-auto"></div>
            <p class="mt-2 text-gray-700">Cargando...</p>
        </div>
    </div>

    <!-- Contenedor principal de la aplicación -->
    <div id="mainContainer" class="hidden w-full max-w-4xl p-4">
        <!-- Encabezado con botones -->
        <header class="flex flex-col md:flex-row justify-between items-center py-4 px-6 bg-white rounded-md mb-4">
            <h1 class="text-3xl font-bold text-blue-600 mb-2 md:mb-0">A3</h1>
            <div class="flex items-center space-x-2 mt-2 md:mt-0">
                <button id="createProfileBtn" class="py-2 px-4 rounded-md font-semibold text-white bg-blue-600 hover:bg-blue-700">
                    Crear Perfil
                </button>
                <button id="toggleChatBtn" class="py-2 px-4 rounded-md font-semibold text-white bg-green-500 hover:bg-green-600">
                    <i class="fas fa-comment-dots"></i> Chat
                </button>
            </div>
        </header>

        <!-- Contenedor para mostrar perfiles -->
        <div id="profilesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Los perfiles se renderizarán aquí -->
            <p class="text-center text-gray-500 col-span-full">Cargando perfiles...</p>
        </div>
    </div>

    <!-- Modal para creación de perfil -->
    <div id="profileModal" class="modal hidden">
        <div class="modal-content">
            <button id="closeProfileModalBtn" class="close-modal-btn">&times;</button>
            <h2 class="text-2xl font-bold text-center mb-4">Crea tu Perfil</h2>
            <form id="profileForm" class="space-y-3">
                <input type="text" id="nickname" required placeholder="Apodo" class="w-full px-3 py-2 border rounded-md">
                <select id="gender" required class="w-full px-3 py-2 border rounded-md">
                    <option value="">Selecciona tu género</option>
                    <option value="Hombre">Hombre</option>
                    <option value="Mujer">Mujer</option>
                </select>
                <input type="number" id="age" required min="18" max="99" placeholder="Edad" class="w-full px-3 py-2 border rounded-md">
                <select id="district" required class="w-full px-3 py-2 border rounded-md"></select>
                <input type="number" id="height" required min="120" max="220" placeholder="Estatura (cm)" class="w-full px-3 py-2 border rounded-md">
                <input type="tel" id="whatsapp" placeholder="Número de WhatsApp" class="w-full px-3 py-2 border rounded-md">
                <div>
                    <label class="block text-sm text-gray-700">Fotos del Perfil (hasta 3)</label>
                    <input type="file" id="profilePhotos" accept="image/png, image/jpeg" multiple class="w-full text-sm text-gray-500 mt-1">
                    <div id="imagePreviews" class="flex gap-2 mt-2"></div>
                </div>
                <div id="modalMessageBox" class="hidden mt-2 p-2 rounded-md text-sm text-center"></div>
                <button type="submit" class="w-full py-2 px-4 rounded-md font-semibold text-white bg-blue-600 hover:bg-blue-700">
                    Guardar Perfil
                </button>
            </form>
        </div>
    </div>

    <!-- Contenedor del chat -->
    <div id="chatContainer" class="hidden">
        <div class="bg-blue-600 text-white p-3 rounded-t-md flex justify-between items-center">
            <h3 class="text-lg font-semibold">Chat Público</h3>
            <button id="closeChatBtn" class="text-white text-xl">&times;</button>
        </div>
        <div id="chatBody" class="p-3 overflow-y-auto flex-grow bg-gray-50 space-y-2">
            <!-- Mensajes del chat se renderizarán aquí -->
        </div>
        <div class="p-3 border-t flex items-center space-x-2">
            <input type="text" id="chatMessageInput" placeholder="Escribe un mensaje..." class="flex-grow p-2 border rounded-md">
            <button id="sendChatBtn" class="bg-blue-600 text-white p-2 rounded-md">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <script type="module">
        // Importar los SDK de Firebase necesarios
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, onSnapshot, collection, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        // Variables globales proporcionadas por el entorno
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let auth;
        let db;
        let userId = null;
        let userProfile = null;

        // Obtener elementos del DOM
        const loadingScreen = document.getElementById('loadingScreen');
        const mainContainer = document.getElementById('mainContainer');
        const profilesList = document.getElementById('profilesList');
        const createProfileBtn = document.getElementById('createProfileBtn');
        const toggleChatBtn = document.getElementById('toggleChatBtn');
        const chatContainer = document.getElementById('chatContainer');
        const closeChatBtn = document.getElementById('closeChatBtn');
        const chatBody = document.getElementById('chatBody');
        const chatMessageInput = document.getElementById('chatMessageInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const profileModal = document.getElementById('profileModal');
        const closeProfileModalBtn = document.getElementById('closeProfileModalBtn');
        const profileForm = document.getElementById('profileForm');
        const nicknameInput = document.getElementById('nickname');
        const genderSelect = document.getElementById('gender');
        const ageInput = document.getElementById('age');
        const districtSelect = document.getElementById('district');
        const heightInput = document.getElementById('height');
        const whatsappInput = document.getElementById('whatsapp');
        const profilePhotosInput = document.getElementById('profilePhotos');
        const imagePreviewsContainer = document.getElementById('imagePreviews');
        const modalMessageBox = document.getElementById('modalMessageBox');

        // Lista de distritos de Lima
        const limaDistricts = [
            "Ancón", "Ate", "Barranco", "Breña", "Carabayllo", "Chaclacayo", "Chorrillos", "Cieneguilla",
            "Comas", "El Agustino", "Independencia", "Jesús María", "La Molina", "La Victoria", "Lince",
            "Los Olivos", "Lurigancho-Chosica", "Lurín", "Magdalena del Mar", "Pueblo Libre", "Miraflores",
            "Pachacámac", "Pucusana", "Puente Piedra", "Punta Hermosa", "Punta Negra", "Rímac",
            "San Bartolo", "San Borja", "San Isidro", "San Juan de Lurigancho", "San Juan de Miraflores",
            "San Luis", "San Martín de Porres", "San Miguel", "Santa Anita", "Santa María del Mar",
            "Santa Rosa", "Santiago de Surco", "Surquillo", "Villa El Salvador", "Villa María del Triunfo"
        ].sort();

        function populateDistricts() {
            districtSelect.innerHTML = `<option value="">Selecciona tu distrito</option>`;
            limaDistricts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
        }
        
        function showModalMessage(message, isError = true) {
            modalMessageBox.textContent = message;
            modalMessageBox.classList.remove('hidden');
            if (isError) {
                modalMessageBox.classList.remove('bg-green-100', 'text-green-700');
                modalMessageBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                modalMessageBox.classList.remove('bg-red-100', 'text-red-700');
                modalMessageBox.classList.add('bg-green-100', 'text-green-700');
            }
        }

        // Inicializar Firebase y configurar el oyente de autenticación
        async function initializeFirebase() {
            loadingScreen.classList.remove('hidden');
            mainContainer.classList.add('hidden');
            
            if (!firebaseConfig) {
                loadingScreen.innerHTML = `<p class="text-red-500 font-bold p-4">Error: La configuración de Firebase no se ha encontrado.</p>`;
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await fetchUserProfile(user.uid);
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                    loadingScreen.classList.add('hidden');
                    mainContainer.classList.remove('hidden');
                });
            } catch (e) {
                console.error("Error de inicialización de Firebase:", e);
                loadingScreen.innerHTML = `<p class="text-red-500 font-bold">Error: ${e.message}</p>`;
            }
        }

        // Obtener el perfil del usuario después de la autenticación
        async function fetchUserProfile(uid) {
            const userProfileRef = doc(db, `/artifacts/${appId}/public/data/profiles`, uid);
            const docSnap = await getDoc(userProfileRef);
            if (docSnap.exists()) {
                userProfile = docSnap.data();
                createProfileBtn.textContent = 'Mi Perfil';
                toggleChatBtn.disabled = false;
                setupProfileListener();
                setupChatListener();
            } else {
                userProfile = null;
                createProfileBtn.textContent = 'Crear Perfil';
                toggleChatBtn.disabled = true;
                setupProfileListener('Mujer');
            }
        }

        // Configurar el oyente de perfiles en tiempo real
        function setupProfileListener(filterGender = null) {
            let profilesQuery;
            const profilesCollectionPath = `/artifacts/${appId}/public/data/profiles`;
            if (filterGender) {
                profilesQuery = query(collection(db, profilesCollectionPath), where("gender", "==", filterGender));
            } else if (userProfile) {
                const oppositeGender = userProfile.gender === 'Hombre' ? 'Mujer' : 'Hombre';
                profilesQuery = query(collection(db, profilesCollectionPath), where("gender", "==", oppositeGender));
            } else {
                profilesQuery = query(collection(db, profilesCollectionPath));
            }

            onSnapshot(profilesQuery, (snapshot) => {
                const profiles = [];
                snapshot.forEach(doc => {
                    if (doc.id !== userId) {
                         profiles.push({ id: doc.id, ...doc.data() });
                    }
                });
                renderProfiles(profiles);
            }, (error) => {
                console.error("Error al obtener los perfiles:", error);
                profilesList.innerHTML = `<p class="text-center text-red-500 col-span-full">Error de permisos: ${error.message}</p>`;
            });
        }

        // Renderizar los perfiles en la UI
        function renderProfiles(profiles) {
            profilesList.innerHTML = '';
            if (profiles.length === 0) {
                profilesList.innerHTML = `<p class="text-center text-gray-500 col-span-full">No hay perfiles para mostrar.</p>`;
                return;
            }

            profiles.forEach(profile => {
                const profileCard = document.createElement('div');
                profileCard.className = 'bg-white p-4 rounded-md flex flex-col items-center text-center';
                
                let profileImageHtml;
                if (profile.images && profile.images.length > 0) {
                    profileImageHtml = `
                        <div class="flex justify-center -space-x-2 mb-2">
                            ${profile.images.slice(0, 3).map(imgBase64 => `
                                <img class="w-20 h-20 rounded-full object-cover" src="${imgBase64}" alt="Foto de perfil de ${profile.nickname}">
                            `).join('')}
                        </div>
                    `;
                } else {
                    profileImageHtml = `
                        <img class="w-20 h-20 rounded-full" src="https://placehold.co/80x80/e0e7ff/4338ca?text=${profile.nickname.charAt(0).toUpperCase()}" alt="Avatar de ${profile.nickname}">
                    `;
                }

                const whatsappUrl = profile.whatsapp ? `https://wa.me/${profile.whatsapp.replace(/\D/g, '')}` : '#';
                const whatsappButton = profile.whatsapp ? `
                    <a href="${whatsappUrl}" target="_blank" class="mt-2 px-4 py-1 bg-green-500 text-white rounded-md">
                        <i class="fab fa-whatsapp mr-1"></i> Chatear
                    </a>
                ` : '';

                profileCard.innerHTML = `
                    ${profileImageHtml}
                    <h3 class="mt-2 text-lg font-bold">${profile.nickname}</h3>
                    <p class="text-gray-500 text-sm">${profile.gender}</p>
                    <ul class="mt-2 text-gray-700 text-sm">
                        <li>Edad: ${profile.age} años</li>
                        <li>Distrito: ${profile.district}</li>
                    </ul>
                    ${whatsappButton}
                `;
                profilesList.appendChild(profileCard);
            });
        }

        profilePhotosInput.addEventListener('change', (event) => {
            const files = event.target.files;
            imagePreviewsContainer.innerHTML = '';
            if (files.length > 3) {
                showModalMessage("Solo puedes subir un máximo de 3 fotos.");
                profilePhotosInput.value = '';
                return;
            }

            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'w-12 h-12 object-cover rounded-md';
                    imagePreviewsContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });

        createProfileBtn.addEventListener('click', () => {
            populateDistricts();
            profileModal.classList.remove('hidden');
            modalMessageBox.classList.add('hidden');
        });

        closeProfileModalBtn.addEventListener('click', () => {
            profileModal.classList.add('hidden');
        });

        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const files = profilePhotosInput.files;
            const readPromises = Array.from(files).map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            });

            try {
                const base64Images = await Promise.all(readPromises);

                const profileData = {
                    nickname: nicknameInput.value.trim(),
                    gender: genderSelect.value,
                    age: parseInt(ageInput.value),
                    district: districtSelect.value,
                    height: parseInt(heightInput.value),
                    whatsapp: whatsappInput.value.trim(),
                    images: base64Images,
                    createdAt: serverTimestamp()
                };

                if (!profileData.nickname || !profileData.gender || !profileData.age || !profileData.district || !profileData.height) {
                    showModalMessage("Por favor, completa todos los campos requeridos.");
                    return;
                }
                if (profileData.age < 18) {
                    showModalMessage("Debes ser mayor de 18 años para crear un perfil.");
                    return;
                }

                const profileRef = doc(db, `/artifacts/${appId}/public/data/profiles`, userId);
                await setDoc(profileRef, profileData, { merge: true });
                showModalMessage("Perfil creado exitosamente.", false);
                profileModal.classList.add('hidden');
            } catch (error) {
                console.error("Error al crear el perfil:", error);
                showModalMessage(`Error al guardar el perfil: ${error.message}`);
            }
        });

        let isChatOpen = false;
        toggleChatBtn.addEventListener('click', () => {
            if (userProfile) {
                isChatOpen = !isChatOpen;
                chatContainer.classList.toggle('hidden', !isChatOpen);
                if (isChatOpen) {
                    chatBody.scrollTop = chatBody.scrollHeight;
                }
            } else {
                showModalMessage("Por favor, crea un perfil antes de usar el chat.");
                profileModal.classList.remove('hidden');
            }
        });

        closeChatBtn.addEventListener('click', () => {
            chatContainer.classList.add('hidden');
            isChatOpen = false;
        });

        sendChatBtn.addEventListener('click', sendMessage);
        chatMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const messageText = chatMessageInput.value.trim();
            if (messageText === '' || !userProfile) return;
            
            try {
                await addDoc(collection(db, `/artifacts/${appId}/public/data/chat`), {
                    userId: userId,
                    nickname: userProfile.nickname,
                    message: messageText,
                    timestamp: serverTimestamp()
                });
                chatMessageInput.value = '';
                chatBody.scrollTop = chatBody.scrollHeight;
            } catch (error) {
                console.error("Error al enviar el mensaje:", error);
            }
        }
        
        function setupChatListener() {
            onSnapshot(collection(db, `/artifacts/${appId}/public/data/chat`), (snapshot) => {
                chatBody.innerHTML = '';
                const messages = [];
                snapshot.forEach(doc => messages.push(doc.data()));
                messages.sort((a, b) => (a.timestamp ? a.timestamp.toMillis() : 0) - (b.timestamp ? b.timestamp.toMillis() : 0));
                
                messages.forEach(msg => {
                    const isSelf = msg.userId === userId;
                    const messageElement = document.createElement('div');
                    messageElement.className = `p-2 rounded-md max-w-[80%] ${isSelf ? 'bg-blue-200 self-end' : 'bg-gray-200 self-start'}`;
                    const senderName = isSelf ? 'Tú' : (msg.nickname || 'Anónimo');
                    messageElement.innerHTML = `<p class="font-bold text-sm">${senderName}</p><p>${msg.message}</p>`;
                    chatBody.appendChild(messageElement);
                });
                chatBody.scrollTop = chatBody.scrollHeight;
            }, (error) => {
                console.error("Error al obtener los mensajes del chat:", error);
            });
        }
        
        window.onload = initializeFirebase;
    </script>
</body>
</html>
