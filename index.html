<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 2rem;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            text-align: center;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <div id="loadingScreen" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-gray-900 mx-auto"></div>
            <p class="mt-4 text-gray-700">Cargando...</p>
        </div>
    </div>

    <div id="loginRegisterContainer" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Crea o Inicia Sesión</h1>
            <p class="text-gray-600 text-center mb-8">Debes ser mayor de 18 años para acceder.</p>
            <div class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="tu@email.com">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                    <input type="password" id="password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="********">
                </div>
                <div>
                    <label for="birthdate" class="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label>
                    <input type="date" id="birthdate" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="gender" class="block text-sm font-medium text-gray-700">Género</label>
                    <select id="gender" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="Hombre">Hombre</option>
                        <option value="Mujer">Mujer</option>
                    </select>
                </div>
                
                <!-- Campos adicionales para mujeres -->
                <div id="mujerFields" class="hidden space-y-4">
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700">Descripción</label>
                        <textarea id="description" rows="3" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Escribe algo sobre ti..."></textarea>
                    </div>
                    <div>
                        <label for="age" class="block text-sm font-medium text-gray-700">Edad</label>
                        <select id="age" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div>
                        <label for="height" class="block text-sm font-medium text-gray-700">Estatura (cm)</label>
                        <input type="number" id="height" min="120" max="220" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: 165">
                    </div>
                    <div>
                        <label for="district" class="block text-sm font-medium text-gray-700">Distrito</label>
                        <select id="district" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div>
                        <label for="telegram" class="block text-sm font-medium text-gray-700">Enlace de Telegram (Opcional)</label>
                        <input type="text" id="telegram" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: @tunombredeusuario">
                    </div>
                    <div>
                        <label for="whatsapp" class="block text-sm font-medium text-gray-700">Número de WhatsApp (Opcional)</label>
                        <input type="tel" id="whatsapp" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: +51 987654321">
                    </div>
                    <div class="flex items-center">
                        <input id="callsOnly" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="callsOnly" class="ml-2 block text-sm text-gray-700">Solo para llamadas</label>
                    </div>
                </div>
            </div>
            <div id="messageBox" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm text-center"></div>
            <div class="mt-6 flex flex-col space-y-3">
                <button id="registerBtn" class="w-full py-3 px-4 rounded-md font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">Crear Perfil</button>
                <button id="loginBtn" class="w-full py-3 px-4 rounded-md font-semibold text-blue-600 bg-white border border-blue-600 hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">Iniciar Sesión</button>
            </div>
        </div>
    </div>

    <div id="profileListContainer" class="hidden min-h-screen p-4">
        <header class="flex justify-between items-center py-4 px-6 bg-white shadow-md rounded-b-xl">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Perfiles Disponibles</h1>
                <p id="currentUserId" class="text-sm text-gray-500 mt-1"></p>
            </div>
            <button id="logoutBtn" class="py-2 px-4 rounded-md font-semibold text-white bg-red-500 hover:bg-red-600 transition duration-300">Cerrar Sesión</button>
        </header>
        <div id="profilesGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mt-6">
            <!-- Los perfiles se renderizarán aquí -->
        </div>
    </div>

    <div id="reportConfirmBox" class="message-box hidden">
        <h3 class="text-xl font-bold mb-4">Confirmar Reporte</h3>
        <p class="text-gray-600 mb-6">¿Estás seguro de que quieres reportar este perfil?</p>
        <div class="flex justify-center space-x-4">
            <button id="confirmReportBtn" class="py-2 px-4 rounded-md font-semibold text-white bg-red-600 hover:bg-red-700 transition duration-300">Sí, Reportar</button>
            <button id="cancelReportBtn" class="py-2 px-4 rounded-md font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition duration-300">Cancelar</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer el nivel de registro para depuración
        setLogLevel('debug');

        // Variables globales
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Referencias del DOM
        const loadingScreen = document.getElementById('loadingScreen');
        const loginRegisterContainer = document.getElementById('loginRegisterContainer');
        const profileListContainer = document.getElementById('profileListContainer');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const birthdateInput = document.getElementById('birthdate');
        const genderSelect = document.getElementById('gender');
        const registerBtn = document.getElementById('registerBtn');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const profilesGrid = document.getElementById('profilesGrid');
        const messageBox = document.getElementById('messageBox');
        const currentUserIdDisplay = document.getElementById('currentUserId');
        const mujerFields = document.getElementById('mujerFields');
        const descriptionInput = document.getElementById('description');
        const ageSelect = document.getElementById('age');
        const heightInput = document.getElementById('height');
        const districtSelect = document.getElementById('district');
        const telegramInput = document.getElementById('telegram');
        const whatsappInput = document.getElementById('whatsapp');
        const callsOnlyCheckbox = document.getElementById('callsOnly');
        const reportConfirmBox = document.getElementById('reportConfirmBox');
        const confirmReportBtn = document.getElementById('confirmReportBtn');
        const cancelReportBtn = document.getElementById('cancelReportBtn');

        let userProfileData = null;
        let profileToReportId = null;

        // Lista de distritos de Lima y Callao
        const limaDistricts = [
            "Ancón", "Ate", "Barranco", "Breña", "Carabayllo", "Chaclacayo", "Chorrillos", "Cieneguilla",
            "Comas", "El Agustino", "Independencia", "Jesús María", "La Molina", "La Victoria", "Lince",
            "Los Olivos", "Lurigancho-Chosica", "Lurín", "Magdalena del Mar", "Pueblo Libre", "Miraflores",
            "Pachacámac", "Pucusana", "Puente Piedra", "Punta Hermosa", "Punta Negra", "Rímac",
            "San Bartolo", "San Borja", "San Isidro", "San Juan de Lurigancho", "San Juan de Miraflores",
            "San Luis", "San Martín de Porres", "San Miguel", "Santa Anita", "Santa María del Mar",
            "Santa Rosa", "Santiago de Surco", "Surquillo", "Villa El Salvador", "Villa María del Triunfo"
        ];

        const callaoDistricts = [
            "Bellavista", "Callao", "Carmen de la Legua-Reynoso", "La Perla", "La Punta", "Ventanilla", "Mi Perú"
        ];

        // Llenar los menús desplegables
        function populateSelects() {
            // Edad
            for (let i = 18; i <= 45; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                ageSelect.appendChild(option);
            }

            // Distritos
            const allDistricts = [...limaDistricts, ...callaoDistricts].sort();
            allDistricts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
        }
        populateSelects();

        // Función para mostrar un mensaje
        function showMessage(message, isError = true) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            if (isError) {
                messageBox.classList.remove('bg-green-100', 'text-green-700');
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                messageBox.classList.remove('bg-red-100', 'text-red-700');
                messageBox.classList.add('bg-green-100', 'text-green-700');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        // Función para validar la edad
        const isAdult = (birthdateStr) => {
            const birthdate = new Date(birthdateStr);
            const today = new Date();
            let age = today.getFullYear() - birthdate.getFullYear();
            const m = today.getMonth() - birthdate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthdate.getDate())) {
                age--;
            }
            return age >= 18;
        };

        // Escuchar el estado de autenticación
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // El usuario está autenticado, intentar obtener su perfil
                    const userProfileRef = doc(db, `/artifacts/${appId}/public/data/profiles`, user.uid);
                    const docSnap = await getDoc(userProfileRef);

                    if (docSnap.exists()) {
                        userProfileData = docSnap.data();
                        showMainApp(user.uid);
                    } else {
                        // Perfil no encontrado, mostrar la pantalla de registro
                        showLoginRegister();
                    }
                } catch (error) {
                    console.error("Error al obtener el perfil del usuario:", error);
                    showLoginRegister();
                }
            } else {
                showLoginRegister();
            }
            loadingScreen.classList.add('hidden');
        });

        // Autenticación inicial con token o anónima
        const initialAuth = async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error en la autenticación inicial:", error);
                await signInAnonymously(auth);
            }
        };
        initialAuth();

        // Funciones para alternar vistas
        function showMainApp(userId) {
            loginRegisterContainer.classList.add('hidden');
            profileListContainer.classList.remove('hidden');
            currentUserIdDisplay.textContent = `Tu ID de usuario: ${userId}`;
            setupProfileListener();
        }

        function showLoginRegister() {
            loginRegisterContainer.classList.remove('hidden');
            profileListContainer.classList.add('hidden');
            userProfileData = null;
        }

        // Mostrar/ocultar campos adicionales para mujeres
        genderSelect.addEventListener('change', () => {
            if (genderSelect.value === 'Mujer') {
                mujerFields.classList.remove('hidden');
            } else {
                mujerFields.classList.add('hidden');
            }
        });

        // Manejar el registro de nuevos perfiles
        registerBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            const birthdate = birthdateInput.value;
            const gender = genderSelect.value;
            
            if (!email || !password || !birthdate) {
                showMessage("Por favor, completa todos los campos.");
                return;
            }

            if (!isAdult(birthdate)) {
                showMessage("Debes ser mayor de 18 años para crear un perfil.");
                return;
            }

            // Validar campos adicionales si el género es Mujer
            if (gender === 'Mujer') {
                const age = ageSelect.value;
                const height = heightInput.value;
                const district = districtSelect.value;

                if (!age || !height || !district) {
                    showMessage("Por favor, completa todos los campos del perfil.");
                    return;
                }
                if (height < 120 || height > 220) {
                    showMessage("La estatura debe estar entre 120 cm y 220 cm.");
                    return;
                }
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const profileData = {
                    email: email,
                    gender: gender,
                    birthdate: birthdate,
                    createdAt: new Date().toISOString()
                };

                // Añadir campos adicionales si el género es Mujer
                if (gender === 'Mujer') {
                    profileData.description = descriptionInput.value;
                    profileData.age = ageSelect.value;
                    profileData.height = heightInput.value;
                    profileData.district = districtSelect.value;
                    profileData.telegram = telegramInput.value;
                    profileData.whatsapp = whatsappInput.value;
                    profileData.callsOnly = callsOnlyCheckbox.checked;
                }

                await setDoc(doc(db, `/artifacts/${appId}/public/data/profiles`, user.uid), profileData);
                showMessage("Perfil creado exitosamente.", false);
            } catch (error) {
                console.error("Error al crear el perfil:", error);
                let errorMessage = "Ocurrió un error. Intenta de nuevo.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "El email ya está en uso. Intenta iniciar sesión.";
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = "Error de autenticación. Por favor, habilite el método de inicio de sesión por 'Correo electrónico/Contraseña' en la consola de su proyecto de Firebase.";
                }
                showMessage(errorMessage);
            }
        });

        // Manejar el inicio de sesión
        loginBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;

            if (!email || !password) {
                showMessage("Por favor, ingresa tu email y contraseña.");
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage("Sesión iniciada exitosamente.", false);
            } catch (error) {
                console.error("Error al iniciar sesión:", error);
                let errorMessage = "Email o contraseña incorrectos.";
                if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = "Error de autenticación. Por favor, habilite el método de inicio de sesión por 'Correo electrónico/Contraseña' en la consola de su proyecto de Firebase.";
                }
                showMessage(errorMessage);
            }
        });

        // Manejar el cierre de sesión
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("Sesión cerrada");
                profilesGrid.innerHTML = '';
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
            }
        });

        // Función para renderizar los perfiles
        function renderProfiles(profiles) {
            profilesGrid.innerHTML = '';
            const fragment = document.createDocumentFragment();

            profiles.forEach(profile => {
                const profileCard = document.createElement('div');
                profileCard.className = 'bg-white p-6 rounded-xl shadow-md flex flex-col transition-transform transform hover:scale-105 duration-300';
                
                let contactInfo = '';
                if (profile.gender === 'Mujer') {
                    contactInfo = `
                        <p class="text-gray-600 mt-2">Edad: ${profile.age} años</p>
                        <p class="text-gray-600">Estatura: ${profile.height} cm</p>
                        <p class="text-gray-600">Distrito: ${profile.district}</p>
                        ${profile.description ? `<p class="text-gray-600 mt-2 italic">"${profile.description}"</p>` : ''}
                        <div class="mt-4 flex items-center space-x-2">
                            ${profile.telegram ? `<a href="https://t.me/${profile.telegram.replace('@', '')}" target="_blank" class="text-blue-500 hover:text-blue-700 transition duration-300"><i class="fab fa-telegram fa-2x"></i></a>` : ''}
                            ${profile.whatsapp ? `<a href="https://wa.me/${profile.whatsapp.replace(/[^0-9]/g, '')}" target="_blank" class="text-green-500 hover:text-green-700 transition duration-300"><i class="fab fa-whatsapp fa-2x"></i></a>` : ''}
                            ${profile.whatsapp && profile.callsOnly ? `<span class="text-sm text-gray-500">(Solo llamadas)</span>` : ''}
                        </div>
                    `;
                }

                profileCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold text-gray-800">${profile.email.split('@')[0]}</h2>
                        <button class="report-btn text-red-500 hover:text-red-700 transition duration-300" data-profile-id="${profile.id}">
                            <i class="fas fa-flag"></i>
                        </button>
                    </div>
                    <p class="text-gray-600 mt-2">Género: ${profile.gender}</p>
                    ${contactInfo}
                    <p class="text-sm text-gray-400 mt-auto pt-4">ID: ${profile.id}</p>
                `;
                fragment.appendChild(profileCard);
            });

            profilesGrid.appendChild(fragment);

            // Agregar listeners para los botones de reportar
            document.querySelectorAll('.report-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    profileToReportId = e.currentTarget.dataset.profileId;
                    reportConfirmBox.classList.remove('hidden');
                });
            });
        }

        // Configurar el listener para los perfiles en tiempo real
        function setupProfileListener() {
            const profilesCollectionRef = collection(db, `/artifacts/${appId}/public/data/profiles`);
            const q = query(profilesCollectionRef);

            onSnapshot(q, (snapshot) => {
                const allProfiles = [];
                snapshot.forEach((doc) => {
                    allProfiles.push({ id: doc.id, ...doc.data() });
                });
                
                let filteredProfiles = [];
                if (userProfileData && userProfileData.gender === 'Hombre') {
                    // Si el usuario es hombre, solo puede ver perfiles de mujeres
                    filteredProfiles = allProfiles.filter(profile => profile.gender === 'Mujer');
                } else if (userProfileData && userProfileData.gender === 'Mujer') {
                    // Si el usuario es mujer, puede ver perfiles de hombres y mujeres
                    filteredProfiles = allProfiles;
                } else {
                    // En caso de que el perfil del usuario no esté disponible, no mostrar nada
                    filteredProfiles = [];
                }

                renderProfiles(filteredProfiles);
            }, (error) => {
                console.error("Error al obtener los perfiles:", error);
                showMessage("No se pudieron cargar los perfiles. Inténtalo de nuevo.");
            });
        }

        // Manejar la confirmación de reporte
        confirmReportBtn.addEventListener('click', async () => {
            if (profileToReportId) {
                try {
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/reports`), {
                        reportedProfileId: profileToReportId,
                        reporterUserId: auth.currentUser.uid,
                        timestamp: new Date().toISOString()
                    });
                    showMessage("Perfil reportado exitosamente.", false);
                } catch (error) {
                    console.error("Error al reportar el perfil:", error);
                    showMessage("No se pudo enviar el reporte. Inténtalo de nuevo.");
                } finally {
                    reportConfirmBox.classList.add('hidden');
                    profileToReportId = null;
                }
            }
        });

        // Manejar la cancelación del reporte
        cancelReportBtn.addEventListener('click', () => {
            reportConfirmBox.classList.add('hidden');
            profileToReportId = null;
        });
    </script>
</body>
</html>
